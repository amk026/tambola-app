<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes"
    />
    <title>üéØ TAMBOLA ¬∑ MOBILE</title>
    <!-- Google Font Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <!-- Socket.IO client -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
      /* ---------- RESET & GLOBAL ---------- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(145deg, #0b1a2a, #1e2f3f);
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
      }

      /* main container ‚Äì full width on mobile */
      .game-container {
        width: 100%;
        max-width: 500px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 32px;
        padding: 20px 16px;
        box-shadow: 0 25px 50px -10px rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      /* ---------- TYPOGRAPHY & UTILS ---------- */
      h2 {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1e2f3f;
        margin-bottom: 16px;
        letter-spacing: -0.3px;
      }

      /* ---------- TAB BAR (only visible in host view, only Player tab shown) ---------- */
      .tab-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: #f0f4f8;
        padding: 6px;
        border-radius: 60px;
      }
      .tab-bar.hidden {
        display: none;
      }
      .tab {
        flex: 1;
        text-align: center;
        padding: 14px 0;
        font-weight: 600;
        font-size: 1rem;
        color: #2c3e50;
        background: transparent;
        border: none;
        border-radius: 50px;
        transition: 0.2s;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .tab.active {
        background: white;
        color: #1e3c72;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        font-weight: 700;
      }

      /* Back button in player panel ‚Äì only shown when host authenticated */
      .back-to-host {
        width: 100%;
        background: #34495e;
        color: white;
        border: none;
        border-radius: 60px;
        padding: 14px;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .back-to-host.hidden {
        display: none;
      }

      /* logout button ‚Äì appears inside host panel */
      #logoutBtn {
        width: 100%;
        margin-top: 8px;
        margin-bottom: 16px;
        background: #e74c3c !important;
        color: white;
        font-size: 1.1rem;
        padding: 14px;
        border-radius: 60px;
        border: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      /* ---------- STATUS BADGE (inline with title) ---------- */
      .title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .title-row h1 {
        font-size: 1.6rem;
        font-weight: 800;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.5px;
      }
      .status-badge {
        padding: 8px 16px;
        border-radius: 60px;
        font-weight: 700;
        font-size: 0.85rem;
        background: #95a5a6;
        color: white;
        text-transform: uppercase;
        white-space: nowrap;
      }
      .status-badge.booking {
        background: #3498db;
      }
      .status-badge.running {
        background: #27ae60;
        animation: pulse 2s infinite;
      }
      .status-badge.completed {
        background: #7f8c8d;
      }
      .status-badge.countdown {
        background: #e67e22;
        animation: pulse 1s infinite;
      }

      /* ---------- STATS CARDS (scrollable row) ---------- */
      .stats-scroll {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 4px 0 12px 0;
        margin-bottom: 16px;
        scrollbar-width: thin;
        -webkit-overflow-scrolling: touch;
      }
      .stats-scroll::-webkit-scrollbar {
        height: 4px;
        background: #e0e7ef;
        border-radius: 4px;
      }
      .stats-scroll::-webkit-scrollbar-thumb {
        background: #a0b8cc;
        border-radius: 4px;
      }
      .stat-card {
        flex: 0 0 auto;
        width: 110px;
        background: white;
        border-radius: 28px;
        padding: 18px 8px;
        text-align: center;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.03);
      }
      .stat-icon {
        font-size: 1.8rem;
        margin-bottom: 6px;
      }
      .stat-label {
        font-size: 0.7rem;
        color: #5f6b7a;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .stat-value {
        font-size: 1.6rem;
        font-weight: 800;
        color: #1e2f3f;
        line-height: 1.2;
      }
      .stat-value.green {
        color: #27ae60;
      }
      .stat-value.blue {
        color: #3498db;
      }
      .stat-value.orange {
        color: #e67e22;
      }

      /* ---------- TIMESTAMP ROW (compact) ---------- */
      .timestamp-row {
        background: white;
        border-radius: 30px;
        padding: 14px 18px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 0.85rem;
        border: 1px solid rgba(0, 0, 0, 0.03);
        color: #2c3e50;
      }
      .timestamp-item span:first-child {
        font-weight: 700;
        color: #1e3c72;
        margin-right: 5px;
      }

      /* ---------- COUNTDOWN & CURRENT NUMBER CARDS ---------- */
      .countdown-card,
      .current-number-card {
        background: linear-gradient(145deg, #e67e22, #d35400);
        color: white;
        padding: 20px;
        border-radius: 40px;
        text-align: center;
        margin-bottom: 20px;
        display: none;
        box-shadow: 0 15px 25px rgba(230, 126, 34, 0.3);
      }
      .current-number-card {
        background: linear-gradient(145deg, #1e3c72, #2a5298);
      }
      .countdown-card.show,
      .current-number-card.show {
        display: block;
        animation: slideIn 0.3s;
      }
      .countdown-number,
      .current-number-value {
        font-size: 5rem;
        font-weight: 800;
        line-height: 1;
        text-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      }
      .current-number-value {
        font-size: 5rem;
      }

      /* ---------- CALLED NUMBERS (9x10 grid) ---------- */
      .called-wrapper {
        background: white;
        border-radius: 30px;
        padding: 20px 12px;
        margin-bottom: 24px;
      }
      .called-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding: 0 4px;
      }
      .called-header h2 {
        margin-bottom: 0;
      }
      .called-count {
        background: #eef2f6;
        padding: 6px 14px;
        border-radius: 40px;
        font-size: 0.9rem;
        font-weight: 600;
      }
      /* 9x10 grid ‚Äì responsive with horizontal scroll if needed */
      .number-grid {
        display: grid;
        grid-template-columns: repeat(9, minmax(32px, 1fr));
        gap: 4px;
        overflow-x: auto;
        padding-bottom: 4px;
        -webkit-overflow-scrolling: touch;
      }
      .number-grid::-webkit-scrollbar {
        height: 4px;
        background: #e0e7ef;
        border-radius: 4px;
      }
      .number-grid::-webkit-scrollbar-thumb {
        background: #a0b8cc;
        border-radius: 4px;
      }
      .number-cell {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        border-radius: 8px;
        font-weight: 600;
        color: #2c3e50;
        border: 1px solid #e2e8f0;
        font-size: 0.9rem;
      }
      .number-cell.called {
        background: #27ae60;
        color: white;
        border-color: #2ecc71;
      }

      /* ---------- TICKETS (full width cards) ---------- */
      .ticket-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 16px;
        max-height: 500px;
        overflow-y: auto;
        padding: 4px 0;
      }
      .ticket-card {
        background: white;
        border-radius: 32px;
        padding: 20px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.02);
      }
      .ticket-card.available {
        border-left: 8px solid #3498db;
      }
      .ticket-card.booked {
        border-left: 8px solid #e74c3c;
        background: #fff8f8;
      }
      .ticket-card.winner {
        border: 2px solid #f39c12;
        background: #fffaf0;
      }
      .ticket-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .ticket-id {
        font-size: 1.3rem;
        font-weight: 800;
        background: linear-gradient(145deg, #1e3c72, #2a5298);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .ticket-status {
        padding: 8px 16px;
        border-radius: 40px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        background: #ecf0f1;
      }
      .status-available {
        background: #d4edda;
        color: #155724;
      }
      .status-booked {
        background: #f8d7da;
        color: #721c24;
      }
      .status-winner {
        background: #fff3cd;
        color: #856404;
      }

      /* 3x9 ticket numbers */
      .ticket-numbers {
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        gap: 4px;
        background: #f1f5f9;
        padding: 12px;
        border-radius: 24px;
        margin-bottom: 16px;
      }
      .ticket-num {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 600;
        background: white;
        border: 1px solid #dde7f0;
        border-radius: 10px;
      }
      .ticket-num.empty {
        background: #e9edf2;
        border: none;
      }
      .ticket-num.marked {
        background: #27ae60;
        color: white;
        border-color: #2ecc71;
      }

      /* WhatsApp booking button */
      .wa-book-btn {
        width: 100%;
        background: #25d366;
        color: white;
        border: none;
        border-radius: 60px;
        padding: 16px;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        transition: 0.2s;
        -webkit-tap-highlight-color: transparent;
      }
      .wa-book-btn:active {
        transform: scale(0.98);
      }

      /* ---------- SEARCH BAR ---------- */
      .search-bar {
        display: flex;
        gap: 10px;
        margin: 20px 0 10px;
      }
      .search-input {
        flex: 1;
        padding: 16px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 60px;
        font-size: 1rem;
        background: white;
      }
      .search-input:focus {
        border-color: #4b6cb7;
        outline: none;
      }
      .clear-search {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 60px;
        padding: 0 24px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
      }

      /* ---------- HOST CONTROLS ---------- */
      .settings-panel,
      .sequence-panel,
      .game-control-card {
        background: white;
        border-radius: 32px;
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid #edf2f7;
      }
      .sequence-panel {
        border-left: 8px solid #4b6cb7;
      }
      .wa-input-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .wa-input {
        padding: 16px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 60px;
        font-size: 1rem;
      }
      /* Hide number input spinners */
      .wa-input[type="number"]::-webkit-inner-spin-button,
      .wa-input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .wa-input[type="number"] {
        -moz-appearance: textfield;
        appearance: textfield;
      }
      .btn {
        border: none;
        border-radius: 60px;
        padding: 16px 24px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
      }
      .btn-primary {
        background: #1e3c72;
        color: white;
      }
      .btn-success {
        background: #27ae60;
        color: white;
      }
      .btn-danger {
        background: #e74c3c;
        color: white;
      }
      .btn-warning {
        background: #f39c12;
        color: white;
      }

      .game-control-card {
        background: linear-gradient(145deg, #2c3e50, #1e2b38);
        color: white;
      }
      .control-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 16px;
      }
      .control-row .btn {
        flex: 1;
        min-width: 140px;
      }

      /* ---------- BOOKING FORM (host) ---------- */
      .booking-form {
        background: white;
        border-radius: 32px;
        padding: 24px;
        margin-bottom: 24px;
        display: none;
        border: 2px solid #3498db;
      }
      .booking-form.show {
        display: block;
      }
      .booking-form h3 {
        margin-bottom: 16px;
      }
      .booking-input-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .booking-input-group input {
        padding: 16px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 60px;
        font-size: 1rem;
      }
      .booking-actions {
        display: flex;
        gap: 12px;
        margin-top: 8px;
      }
      .booking-actions .btn {
        flex: 1;
      }

      /* ---------- WINNERS LIST ---------- */
      .winner-card {
        background: linear-gradient(145deg, #f39c12, #e67e22);
        color: white;
        padding: 16px 20px;
        border-radius: 40px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
      }

      /* ---------- ANIMATIONS ---------- */
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
        100% {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateY(-10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container" id="gameContainer">
      <!-- ===== TAB BAR (only visible in host view, shows only Player tab) ===== -->
      <div class="tab-bar" id="tabBar">
        <button id="mobilePlayerTab" class="tab active">üë• Player</button>
      </div>

      <!-- ===== HOST PANEL ===== -->
      <div id="hostPanel">
        <!-- Login Section -->
        <div id="loginSection">
          <div
            style="background: white; border-radius: 32px; padding: 32px 20px"
          >
            <div style="text-align: center; margin-bottom: 24px">
              <div style="font-size: 4rem">üîê</div>
              <h2 style="color: #1e3c72">Host Login</h2>
            </div>
            <div style="margin-bottom: 16px">
              <label
                class="stat-label"
                style="display: block; margin-bottom: 8px"
                >Username</label
              >
              <input
                type="text"
                id="username"
                class="search-input"
                placeholder="Enter username"
              />
            </div>
            <div style="margin-bottom: 24px">
              <label
                class="stat-label"
                style="display: block; margin-bottom: 8px"
                >Password</label
              >
              <input
                type="password"
                id="password"
                class="search-input"
                placeholder="Enter password"
              />
            </div>
            <button id="loginBtn" class="btn btn-primary">üîë Login</button>
            <div
              id="loginError"
              style="
                color: #e74c3c;
                margin-top: 16px;
                text-align: center;
                display: none;
              "
            ></div>
            <div
              id="loginLoading"
              style="
                color: #3498db;
                margin-top: 16px;
                text-align: center;
                display: none;
              "
            >
              Logging in...
            </div>
          </div>
        </div>

        <!-- Dashboard (visible after successful login) -->
        <div id="dashboardSection" style="display: none">
          <!-- title row with status badge -->
          <div class="title-row">
            <h1>üéØ TAMBOLA</h1>
            <span id="statusBadge" class="status-badge">NO GAME</span>
          </div>

          <!-- Stats scrollable row -->
          <div class="stats-scroll">
            <div class="stat-card">
              <div class="stat-icon">üé´</div>
              <div class="stat-label">Total</div>
              <div class="stat-value" id="totalTickets">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">‚úÖ</div>
              <div class="stat-label">Booked</div>
              <div class="stat-value green" id="bookedTickets">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">‚ö°</div>
              <div class="stat-label">Available</div>
              <div class="stat-value blue" id="availableTickets">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üèÜ</div>
              <div class="stat-label">Winners</div>
              <div class="stat-value orange" id="winnersCount">0/5</div>
            </div>
          </div>

          <!-- Timestamps -->
          <div class="timestamp-row" id="hostTimestamps">
            <div class="timestamp-item">
              <span>üìÜ</span> <span id="hostCreatedAt">--</span>
            </div>
            <div class="timestamp-item">
              <span>‚è±Ô∏è</span> <span id="hostStartedAt">--</span>
            </div>
            <div class="timestamp-item">
              <span>üèÅ</span> <span id="hostEndedAt">--</span>
            </div>
          </div>

          <!-- WhatsApp settings -->
          <div class="settings-panel">
            <h3 style="margin-bottom: 12px">üì≤ Host WhatsApp</h3>
            <div class="wa-input-group">
              <input
                type="text"
                id="hostWANumber"
                class="wa-input"
                placeholder="e.g. 919876543210"
                value="917629048752"
              />
              <button id="saveWANumberBtn" class="btn btn-primary">
                üíæ Save Number
              </button>
            </div>
          </div>

          <!-- Create Game -->
          <div class="settings-panel" id="createGameSection">
            <h3 style="margin-bottom: 16px">üéÆ Create New Game</h3>
            <div style="display: flex; flex-direction: column; gap: 16px">
              <input
                type="number"
                id="ticketCount"
                class="wa-input"
                value="50"
                min="10"
                max="5000"
              />
              <button id="createGameBtn" class="btn btn-primary">
                üü£ CREATE GAME
              </button>
            </div>
          </div>

          <!-- Custom Sequence Panel -->
          <div
            id="sequenceInputPanel"
            class="sequence-panel"
            style="display: none"
          >
            <div style="font-weight: 700; margin-bottom: 12px">
              üî¢ Draw sequence (1‚Äë90)
            </div>
            <input
              type="text"
              id="customSequenceInput"
              class="wa-input"
              placeholder="e.g. 45,12,78..."
              value="5,12,23,34,45,56,67,78,89,90,1,2,3,4,6,7,8,9,10,11,13,14,15,16,17,18,19,20,21,22,24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,44,46,47,48,49,50,51,52,53,54,55,57,58,59,60,61,62,63,64,65,66,68,69,70,71,72,73,74,75,76,77,79,80,81,82,83,84,85,86,87,88"
            />
            <div
              style="
                font-size: 0.9rem;
                background: #eef2f6;
                padding: 12px;
                border-radius: 40px;
                margin: 12px 0;
              "
            >
              ‚è±Ô∏è After countdown, numbers every 3 sec
            </div>
            <div id="sequenceError" style="color: #e74c3c"></div>
          </div>

          <!-- Game Control Card -->
          <div
            id="gameControlSection"
            class="game-control-card"
            style="display: none"
          >
            <h3 style="color: white">üéØ Game Control</h3>
            <div class="control-row">
              <button id="startGameBtn" class="btn btn-success">
                üü¢ START
              </button>
              <button id="resetGameBtn" class="btn btn-danger">üî¥ RESET</button>
            </div>
            <div style="margin-top: 12px; text-align: center">
              Status: <span id="gameStatus">BOOKING OPEN</span>
            </div>
          </div>

          <!-- Countdown -->
          <div id="hostCountdownCard" class="countdown-card">
            <div>‚è≥ GAME STARTS IN</div>
            <div id="hostCountdownNumber" class="countdown-number">10</div>
            <div id="hostCountdownUnit">steps</div>
          </div>

          <!-- Current Number -->
          <div id="hostCurrentNumber" class="current-number-card">
            <div>üé≤ CURRENT NUMBER</div>
            <div id="hostNumber" class="current-number-value">--</div>
          </div>

          <!-- Called Numbers with horizontal scroll -->
          <div class="called-wrapper">
            <div class="called-header">
              <h2>üî¢ Called</h2>
              <span class="called-count" id="calledCount">0/90</span>
            </div>
            <div id="calledNumbersGrid" class="number-grid"></div>
          </div>

          <!-- Winners List -->
          <div id="winnersList" style="margin-bottom: 24px"></div>

          <!-- Booking Form (host) -->
          <div id="bookingForm" class="booking-form">
            <h3>
              üìù Book Ticket
              <span id="selectedTicketId" style="color: #3498db"></span>
            </h3>
            <div class="booking-input-group">
              <input type="text" id="playerName" placeholder="Player name" />
              <div class="booking-actions">
                <button id="confirmBookingBtn" class="btn btn-success">
                  ‚úî Confirm
                </button>
                <button
                  id="cancelBookingBtn"
                  class="btn"
                  style="background: #95a5a6; color: white"
                >
                  ‚úñ Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Ticket Management with Search -->
          <div style="background: white; border-radius: 32px; padding: 20px">
            <h2 style="margin-bottom: 8px">üé´ Tickets</h2>
            <div class="search-bar">
              <input
                type="text"
                id="hostSearchInput"
                class="search-input"
                placeholder="Search ID or player..."
              />
              <button id="hostClearSearch" class="clear-search">‚úñ</button>
            </div>
            <div id="ticketsGrid" class="ticket-grid"></div>
          </div>

          <!-- Logout button inside host panel -->
          <button id="logoutBtn" style="display: none">üö™ Logout</button>
        </div>
        <!-- end dashboardSection -->
      </div>
      <!-- end hostPanel -->

      <!-- ===== PLAYER PANEL ===== -->
      <div id="playerPanel" style="display: none">
        <!-- Back to Host button ‚Äì shown only when host authenticated -->
        <button id="backToHostBtn" class="back-to-host hidden">
          ‚Üê Back to Host
        </button>

        <!-- title row with status badge -->
        <div class="title-row">
          <h1>üéØ TAMBOLA</h1>
          <span id="playerStatusBadge" class="status-badge">NO GAME</span>
        </div>

        <!-- Stats scroll -->
        <div class="stats-scroll">
          <div class="stat-card">
            <div class="stat-icon">üé´</div>
            <div class="stat-label">Available</div>
            <div class="stat-value blue" id="playerAvailableTickets">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üî¢</div>
            <div class="stat-label">Called</div>
            <div class="stat-value orange" id="playerCalledCount">0/90</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-label">Winners</div>
            <div class="stat-value" id="playerWinnersCount">0/5</div>
          </div>
        </div>

        <!-- Timestamps -->
        <div class="timestamp-row" id="playerTimestamps">
          <div class="timestamp-item">
            <span>üìÜ</span> <span id="playerCreatedAt">--</span>
          </div>
          <div class="timestamp-item">
            <span>‚è±Ô∏è</span> <span id="playerStartedAt">--</span>
          </div>
          <div class="timestamp-item">
            <span>üèÅ</span> <span id="playerEndedAt">--</span>
          </div>
        </div>

        <!-- Countdown -->
        <div id="playerCountdownCard" class="countdown-card">
          <div>‚è≥ GAME STARTS IN</div>
          <div id="playerCountdownNumber" class="countdown-number">10</div>
          <div id="playerCountdownUnit">steps</div>
        </div>

        <!-- Current Number -->
        <div id="playerCurrentNumberCard" class="current-number-card">
          <div>üé≤ CURRENT NUMBER</div>
          <div id="playerNumber" class="current-number-value">--</div>
        </div>

        <!-- Called Numbers -->
        <div class="called-wrapper">
          <div class="called-header">
            <h2>üî¢ Called</h2>
            <span class="called-count" id="playerCalledCountDisplay">0/90</span>
          </div>
          <div id="playerCalledNumbersGrid" class="number-grid"></div>
        </div>

        <!-- Winners -->
        <div id="playerWinnersList" style="margin-bottom: 24px"></div>

        <!-- Player Tickets -->
        <div style="background: white; border-radius: 32px; padding: 20px">
          <h2 style="margin-bottom: 8px">üé´ Available Tickets</h2>
          <div class="search-bar">
            <input
              type="text"
              id="playerSearchInput"
              class="search-input"
              placeholder="Search ticket ID..."
            />
            <button id="playerClearSearch" class="clear-search">‚úñ</button>
          </div>
          <div id="playerTicketsGrid" class="ticket-grid"></div>
        </div>
      </div>
      <!-- end playerPanel -->
    </div>
    <!-- end gameContainer -->

    <script>
      (function () {
        // ---------- Connect to server ----------
        const socket = io();

        // ---------- Local GameState ----------
        let GameState = {
          tickets: [],
          calledNumbers: [],
          winners: [],
          status: "NO_ACTIVE_GAME",
          drawSequence: [],
          drawIndex: 0,
          gameCreatedAt: null,
          gameStartedAt: null,
          gameEndedAt: null,
          countdownEndTime: null,
          lastCallTime: null,
          isAdminAuthenticated: false, // client-side flag, set after server confirms login
          selectedTicket: null,
        };

        // ---------- Countdown interval ----------
        let countdownInterval = null;

        // ---------- UI object (same as before, but we'll add a method to update back button visibility) ----------
        const UI = {
          renderAll() {
            if (document.getElementById("hostPanel").style.display !== "none") {
              this.renderHost();
            } else {
              this.renderPlayer();
            }
            this.updateStatusBadge();
            this.updateControlSections();
            this.updateBackButton(); // show/hide back button in player view
          },
          renderHost() {
            this.renderCalledNumbers();
            this.renderTicketsAdmin();
            this.renderWinners("admin");
            this.updateStats();
            this.renderTimestamps("host");
            this.renderCountdownUI("host");
            this.showCurrentNumber();
          },
          renderPlayer() {
            this.renderCalledNumbers();
            this.renderTicketsPlayer();
            this.renderWinners("player");
            this.updateStats();
            this.renderTimestamps("player");
            this.renderCountdownUI("player");
            this.showCurrentNumber();
          },
          renderCalledNumbers() {
            const adminGrid = document.getElementById("calledNumbersGrid");
            const playerGrid = document.getElementById(
              "playerCalledNumbersGrid",
            );
            let html = "";
            for (let i = 1; i <= 90; i++)
              html += `<div class="number-cell ${GameState.calledNumbers.includes(i) ? "called" : ""}">${i}</div>`;
            if (adminGrid) adminGrid.innerHTML = html;
            if (playerGrid) playerGrid.innerHTML = html;
            document.getElementById("calledCount") &&
              (document.getElementById("calledCount").innerHTML =
                `${GameState.calledNumbers.length}/90`);
            document.getElementById("playerCalledCountDisplay") &&
              (document.getElementById("playerCalledCountDisplay").innerHTML =
                `${GameState.calledNumbers.length}/90`);
            document.getElementById("playerCalledCount") &&
              (document.getElementById("playerCalledCount").innerHTML =
                `${GameState.calledNumbers.length}/90`);
          },
          renderTicketsAdmin() {
            const grid = document.getElementById("ticketsGrid");
            if (!grid) return;
            if (!GameState.tickets.length) {
              grid.innerHTML =
                '<div style="padding:50px; color:#7f8c8d; text-align:center;">üé´ No tickets. Create a game.</div>';
              return;
            }
            let filtered = filterTickets(
              GameState.tickets,
              currentHostSearch,
              "admin",
            );
            let html = "";
            filtered.forEach((t) => {
              let classes = "ticket-card";
              if (t.isWinner) classes += " winner";
              else if (t.isBooked) classes += " booked";
              else classes += " available";
              html += `<div class="${classes}" onclick="window.selectTicketHandler('${t.id}')">`;
              html += `<div class="ticket-header"><span class="ticket-id">${t.id}</span>`;
              if (t.isWinner)
                html += `<span class="ticket-status status-winner">üèÜ WINNER #${t.winnerOrder}</span>`;
              else if (t.isBooked)
                html += `<span class="ticket-status status-booked">üìå ${t.bookedBy || "Booked"}</span>`;
              else
                html += `<span class="ticket-status status-available">‚ö° Available</span>`;
              html += `</div><div class="ticket-numbers">`;
              for (let r = 0; r < 3; r++)
                for (let c = 0; c < 9; c++) {
                  let num = t.numbers[r][c];
                  if (num === 0) {
                    html += `<div class="ticket-num empty"></div>`;
                  } else {
                    const markedClass = GameState.calledNumbers.includes(num)
                      ? "marked"
                      : "";
                    html += `<div class="ticket-num ${markedClass}">${num}</div>`;
                  }
                }
              html += `</div></div>`;
            });
            grid.innerHTML =
              html ||
              '<div style="padding:50px; color:#7f8c8d; text-align:center;">üîç No tickets match search.</div>';
          },
          renderTicketsPlayer() {
            const grid = document.getElementById("playerTicketsGrid");
            if (!grid) return;
            if (!GameState.tickets.length) {
              grid.innerHTML =
                '<div style="padding:50px; color:#7f8c8d; text-align:center;">üé´ No tickets available</div>';
              return;
            }
            let filtered = filterTickets(
              GameState.tickets,
              currentPlayerSearch,
              "player",
            );
            let html = "";
            filtered.forEach((t) => {
              let classes = "ticket-card";
              if (t.isWinner) classes += " winner";
              else if (t.isBooked) classes += " booked";
              else classes += " available";
              html += `<div class="${classes}">`;
              html += `<div class="ticket-header"><span class="ticket-id">${t.id}</span>`;
              if (t.isWinner)
                html += `<span class="ticket-status status-winner">üèÜ WINNER #${t.winnerOrder}</span>`;
              else if (t.isBooked)
                html += `<span class="ticket-status status-booked">üìå ${t.bookedBy || "Booked"}</span>`;
              else
                html += `<span class="ticket-status status-available">‚ö° Available</span>`;
              html += `</div><div class="ticket-numbers">`;
              for (let r = 0; r < 3; r++)
                for (let c = 0; c < 9; c++) {
                  let num = t.numbers[r][c];
                  if (num === 0) html += `<div class="ticket-num empty"></div>`;
                  else
                    html += `<div class="ticket-num ${GameState.calledNumbers.includes(num) ? "marked" : ""}">${num}</div>`;
                }
              html += `</div>`;
              if (!t.isBooked && !t.isWinner) {
                html += `<button onclick="window.openWhatsAppBooking('${t.id}')" class="wa-book-btn">üì≤ Book via WhatsApp</button>`;
              }
              html += `</div>`;
            });
            grid.innerHTML =
              html ||
              '<div style="padding:50px; color:#7f8c8d; text-align:center;">üîç No tickets match search.</div>';
          },
          renderWinners(view) {
            const list =
              view === "admin"
                ? document.getElementById("winnersList")
                : document.getElementById("playerWinnersList");
            if (!list) return;
            if (!GameState.winners.length) {
              list.innerHTML = "";
              return;
            }
            let html = '<h2 style="margin-bottom:20px;">üèÜ Winners</h2>';
            GameState.winners
              .sort((a, b) => a.winnerOrder - b.winnerOrder)
              .forEach((w) => {
                html += `<div class="winner-card"><div style="font-size:2.5rem;">üèÜ</div><div><h3>WINNER #${w.winnerOrder}</h3><p>${w.ticketId} - ${w.playerName}</p></div></div>`;
              });
            list.innerHTML = html;
            document.getElementById("winnersCount") &&
              (document.getElementById("winnersCount").innerHTML =
                `${GameState.winners.length}/5`);
            document.getElementById("playerWinnersCount") &&
              (document.getElementById("playerWinnersCount").innerHTML =
                `${GameState.winners.length}/5`);
          },
          updateStats() {
            let booked = GameState.tickets.filter((t) => t.isBooked).length;
            document.getElementById("totalTickets") &&
              (document.getElementById("totalTickets").innerHTML =
                GameState.tickets.length);
            document.getElementById("bookedTickets") &&
              (document.getElementById("bookedTickets").innerHTML = booked);
            document.getElementById("availableTickets") &&
              (document.getElementById("availableTickets").innerHTML =
                GameState.tickets.length - booked);
            document.getElementById("playerAvailableTickets") &&
              (document.getElementById("playerAvailableTickets").innerHTML =
                GameState.tickets.filter(
                  (t) => !t.isBooked && !t.isWinner,
                ).length);
          },
          updateStatusBadge() {
            let badge = document.getElementById("statusBadge");
            if (badge) {
              badge.innerHTML = GameState.status.replace(/_/g, " ");
              badge.className = "status-badge";
              if (GameState.status === "BOOKING_OPEN")
                badge.classList.add("booking");
              else if (GameState.status === "COUNTDOWN")
                badge.classList.add("countdown");
              else if (GameState.status === "RUNNING")
                badge.classList.add("running");
              else if (GameState.status === "COMPLETED")
                badge.classList.add("completed");
            }
            let playerBadge = document.getElementById("playerStatusBadge");
            if (playerBadge) {
              playerBadge.innerHTML = GameState.status.replace(/_/g, " ");
              playerBadge.className = "status-badge";
              if (GameState.status === "BOOKING_OPEN")
                playerBadge.classList.add("booking");
              else if (GameState.status === "COUNTDOWN")
                playerBadge.classList.add("countdown");
              else if (GameState.status === "RUNNING")
                playerBadge.classList.add("running");
              else if (GameState.status === "COMPLETED")
                playerBadge.classList.add("completed");
            }
            document.getElementById("gameStatus") &&
              (document.getElementById("gameStatus").innerHTML =
                GameState.status.replace(/_/g, " "));
          },
          renderTimestamps(view) {
            const created = GameState.gameCreatedAt
              ? new Date(GameState.gameCreatedAt).toLocaleString()
              : "--";
            const started = GameState.gameStartedAt
              ? new Date(GameState.gameStartedAt).toLocaleString()
              : "--";
            const ended = GameState.gameEndedAt
              ? new Date(GameState.gameEndedAt).toLocaleString()
              : "--";
            if (view === "host") {
              document.getElementById("hostCreatedAt").innerText = created;
              document.getElementById("hostStartedAt").innerText = started;
              document.getElementById("hostEndedAt").innerText = ended;
            } else {
              document.getElementById("playerCreatedAt").innerText = created;
              document.getElementById("playerStartedAt").innerText = started;
              document.getElementById("playerEndedAt").innerText = ended;
            }
          },
          renderCountdownUI(view) {
            const card =
              view === "host"
                ? document.getElementById("hostCountdownCard")
                : document.getElementById("playerCountdownCard");
            const numberEl =
              view === "host"
                ? document.getElementById("hostCountdownNumber")
                : document.getElementById("playerCountdownNumber");
            const unitEl =
              view === "host"
                ? document.getElementById("hostCountdownUnit")
                : document.getElementById("playerCountdownUnit");
            if (!card || !numberEl || !unitEl) return;

            if (
              GameState.status === "COUNTDOWN" &&
              GameState.countdownEndTime
            ) {
              const remain = Math.max(
                0,
                Math.floor((GameState.countdownEndTime - Date.now()) / 1000),
              );
              const step = Math.ceil(remain / 2);
              numberEl.innerText = step;
              unitEl.innerText = "steps";
              card.classList.add("show");
            } else {
              card.classList.remove("show");
            }
          },
          showCurrentNumber() {
            if (GameState.calledNumbers.length > 0) {
              let last =
                GameState.calledNumbers[GameState.calledNumbers.length - 1];
              document.getElementById("hostNumber") &&
                (document.getElementById("hostNumber").innerText = last);
              document.getElementById("playerNumber") &&
                (document.getElementById("playerNumber").innerText = last);
              document.getElementById("hostCurrentNumber") &&
                document
                  .getElementById("hostCurrentNumber")
                  .classList.add("show");
              document.getElementById("playerCurrentNumberCard") &&
                document
                  .getElementById("playerCurrentNumberCard")
                  .classList.add("show");
            } else {
              document.getElementById("hostCurrentNumber") &&
                document
                  .getElementById("hostCurrentNumber")
                  .classList.remove("show");
              document.getElementById("playerCurrentNumberCard") &&
                document
                  .getElementById("playerCurrentNumberCard")
                  .classList.remove("show");
            }
          },
          updateControlSections() {
            const gameControl = document.getElementById("gameControlSection");
            const sequencePanel = document.getElementById("sequenceInputPanel");
            if (!gameControl || !sequencePanel) return;

            if (
              GameState.status !== "NO_ACTIVE_GAME" &&
              GameState.tickets.length > 0
            ) {
              gameControl.style.display = "block";
              if (GameState.status === "BOOKING_OPEN") {
                sequencePanel.style.display = "block";
              } else {
                sequencePanel.style.display = "none";
              }
            } else {
              gameControl.style.display = "none";
              sequencePanel.style.display = "none";
            }
          },
          // New: show/hide back button based on authentication
          updateBackButton() {
            const backBtn = document.getElementById("backToHostBtn");
            if (!backBtn) return;
            if (
              GameState.isAdminAuthenticated &&
              document.getElementById("playerPanel").style.display !== "none"
            ) {
              backBtn.classList.remove("hidden");
            } else {
              backBtn.classList.add("hidden");
            }
          },
          showBookingForm(ticketId) {
            GameState.selectedTicket = ticketId;
            document.getElementById("selectedTicketId").innerHTML = ticketId;
            document.getElementById("bookingForm").classList.add("show");
            document.getElementById("playerName").focus();
          },
          hideBookingForm() {
            document.getElementById("bookingForm").classList.remove("show");
            GameState.selectedTicket = null;
            document.getElementById("playerName").value = "";
          },
        };

        // ---------- Local countdown timer ----------
        function startLocalCountdown() {
          if (countdownInterval) clearInterval(countdownInterval);
          if (GameState.status !== "COUNTDOWN" || !GameState.countdownEndTime)
            return;

          countdownInterval = setInterval(() => {
            UI.renderCountdownUI("host");
            UI.renderCountdownUI("player");

            const remain = Math.max(
              0,
              Math.floor((GameState.countdownEndTime - Date.now()) / 1000),
            );
            if (remain <= 0) {
              clearInterval(countdownInterval);
              countdownInterval = null;
            }
          }, 2000);
        }

        // ---------- Search state ----------
        let currentHostSearch = "";
        let currentPlayerSearch = "";

        function filterTickets(tickets, searchTerm, viewType) {
          if (!searchTerm) {
            if (GameState.status === "COMPLETED") return [];
            return tickets;
          }
          const term = searchTerm.toLowerCase();
          return tickets.filter(
            (t) =>
              t.id.toLowerCase().includes(term) ||
              (t.bookedBy && t.bookedBy.toLowerCase().includes(term)),
          );
        }

        // ---------- Socket event: receive updated state ----------
        socket.on("gameState", (newState) => {
          GameState = { ...GameState, ...newState };
          startLocalCountdown();
          UI.renderAll();
        });

        // ---------- Authentication responses ----------
        socket.on("host:login:success", () => {
          GameState.isAdminAuthenticated = true;
          document.getElementById("loginSection").style.display = "none";
          document.getElementById("dashboardSection").style.display = "block";
          document.getElementById("logoutBtn").style.display = "inline-flex";
          document.getElementById("loginError").style.display = "none";
          document.getElementById("loginLoading").style.display = "none";
          UI.renderAll();
        });

        socket.on("host:login:failure", (data) => {
          document.getElementById("loginError").style.display = "block";
          document.getElementById("loginError").innerText = data.message;
          document.getElementById("loginLoading").style.display = "none";
        });

        // ---------- Host login button ----------
        document
          .getElementById("loginBtn")
          .addEventListener("click", function () {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            document.getElementById("loginLoading").style.display = "block";
            document.getElementById("loginError").style.display = "none";
            socket.emit("host:login", { username, password });
          });

        // ---------- Logout ----------
        document
          .getElementById("logoutBtn")
          .addEventListener("click", function () {
            GameState.isAdminAuthenticated = false;
            document.getElementById("loginSection").style.display = "block";
            document.getElementById("dashboardSection").style.display = "none";
            document.getElementById("logoutBtn").style.display = "none";
            UI.hideBookingForm();
            if (countdownInterval) {
              clearInterval(countdownInterval);
              countdownInterval = null;
            }
            // Optionally, you could also tell the server to de-authenticate, but we'll just rely on client-side for now.
            // The server will keep the socket.isHost flag, but that's fine ‚Äì it's tied to the socket.
          });

        // ---------- WhatsApp number ----------
        document
          .getElementById("saveWANumberBtn")
          .addEventListener("click", function () {
            let wa = document.getElementById("hostWANumber").value.trim();
            if (wa) localStorage.setItem("hostWhatsAppNumber", wa);
            alert("‚úÖ Host WhatsApp number saved");
          });
        const savedWA = localStorage.getItem("hostWhatsAppNumber");
        if (savedWA) document.getElementById("hostWANumber").value = savedWA;

        // ---------- Host actions (all require authentication, but server will also check) ----------
        document
          .getElementById("createGameBtn")
          .addEventListener("click", function () {
            if (!GameState.isAdminAuthenticated) {
              alert("Not authenticated");
              return;
            }
            let count =
              parseInt(document.getElementById("ticketCount").value) || 50;
            if (count < 10) count = 10;
            if (count > 5000) count = 5000;
            socket.emit("host:createGame", { ticketCount: count });
          });

        document
          .getElementById("startGameBtn")
          .addEventListener("click", function () {
            if (!GameState.isAdminAuthenticated) {
              alert("Not authenticated");
              return;
            }
            const inputEl = document.getElementById("customSequenceInput");
            const seqStr = inputEl.value;
            try {
              const parsed = parseCustomSequence(seqStr);
              socket.emit("host:setSequence", { sequence: parsed });
              socket.emit("host:startCountdown");
              document.getElementById("sequenceError").innerText = "";
            } catch (e) {
              document.getElementById("sequenceError").innerText =
                "‚ùå " + e.message;
            }
          });

        document
          .getElementById("resetGameBtn")
          .addEventListener("click", function () {
            if (!GameState.isAdminAuthenticated) {
              alert("Not authenticated");
              return;
            }
            if (confirm("‚ö†Ô∏è Reset game? All data lost!")) {
              socket.emit("host:resetGame");
            }
          });

        document
          .getElementById("confirmBookingBtn")
          .addEventListener("click", function () {
            if (!GameState.isAdminAuthenticated) {
              alert("Not authenticated");
              return;
            }
            let name = document.getElementById("playerName").value.trim();
            if (!name) {
              alert("‚ùå Enter player name");
              return;
            }
            if (GameState.selectedTicket) {
              socket.emit("host:bookTicket", {
                ticketId: GameState.selectedTicket,
                playerName: name,
              });
              UI.hideBookingForm();
            }
          });

        document
          .getElementById("cancelBookingBtn")
          .addEventListener("click", function () {
            UI.hideBookingForm();
          });

        // ---------- WhatsApp booking helper ----------
        window.openWhatsAppBooking = function (ticketId) {
          let hostNumber =
            localStorage.getItem("hostWhatsAppNumber") || "917629048752";
          if (!hostNumber) {
            alert("‚ùå Host WhatsApp number not set.");
            return;
          }
          window.open(
            `https://wa.me/${hostNumber}?text=${encodeURIComponent("Hi Admin, I would like to book ticket " + ticketId + ".")}`,
            "_blank",
          );
        };

        window.selectTicketHandler = function (ticketId) {
          if (!GameState.isAdminAuthenticated) {
            alert("üîê Login as host first");
            return;
          }
          const ticket = GameState.tickets.find((t) => t.id === ticketId);
          if (ticket && !ticket.isBooked && !ticket.isWinner)
            UI.showBookingForm(ticketId);
        };

        // ---------- Sequence parser ----------
        function parseCustomSequence(inputStr) {
          if (!inputStr.trim()) return [];
          let parts = inputStr.split(/[,\s]+/).filter((s) => s.trim() !== "");
          let numbers = [];
          let seen = new Set();
          for (let p of parts) {
            let num = Number(p);
            if (isNaN(num) || num < 1 || num > 90)
              throw new Error(`Invalid: ${p} (must be 1-90)`);
            if (seen.has(num)) throw new Error(`Duplicate: ${num}`);
            seen.add(num);
            numbers.push(num);
          }
          if (numbers.length === 0) throw new Error("Sequence empty");
          return numbers;
        }

        // ---------- Search handlers ----------
        document
          .getElementById("hostSearchInput")
          ?.addEventListener("input", (e) => {
            currentHostSearch = e.target.value;
            UI.renderHost();
          });
        document
          .getElementById("hostClearSearch")
          ?.addEventListener("click", () => {
            document.getElementById("hostSearchInput").value = "";
            currentHostSearch = "";
            UI.renderHost();
          });
        document
          .getElementById("playerSearchInput")
          ?.addEventListener("input", (e) => {
            currentPlayerSearch = e.target.value;
            UI.renderPlayer();
          });
        document
          .getElementById("playerClearSearch")
          ?.addEventListener("click", () => {
            document.getElementById("playerSearchInput").value = "";
            currentPlayerSearch = "";
            UI.renderPlayer();
          });

        // ---------- Tab and back button navigation ----------
        document
          .getElementById("mobilePlayerTab")
          .addEventListener("click", () => {
            window.location.hash = "#player";
          });

        document
          .getElementById("backToHostBtn")
          .addEventListener("click", () => {
            window.location.hash = "#host";
          });

        // ---------- Routing (with hash) ----------
        function routeView() {
          // Clear countdown interval on view change
          if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
          }

          let hash = window.location.hash || "#host";
          if (hash === "#host") {
            document.getElementById("hostPanel").style.display = "block";
            document.getElementById("playerPanel").style.display = "none";
            // Show tab bar, hide back button (handled by updateBackButton)
            document.getElementById("tabBar").classList.remove("hidden");
            UI.renderHost();
          } else {
            document.getElementById("hostPanel").style.display = "none";
            document.getElementById("playerPanel").style.display = "block";
            // Hide tab bar, back button visibility handled by updateBackButton
            document.getElementById("tabBar").classList.add("hidden");
            UI.renderPlayer();
          }

          // Update active tab (only one tab exists)
          const playerTab = document.getElementById("mobilePlayerTab");
          if (hash === "#player") {
            playerTab.classList.add("active");
          } else {
            playerTab.classList.remove("active");
          }

          UI.updateBackButton(); // ensure back button correct state
        }

        window.addEventListener("hashchange", routeView);
        routeView();
      })();
    </script>
  </body>
</html>
